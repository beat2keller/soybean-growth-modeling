Weather_data_Melt_all <- rbind(weather_Delley, weather_Eschikon)
Weather_data_Melt_all$DayNight <- Weather_data_Melt_all$Daytime
rm(weather_na, weather_na_no_WeatherVariable)
gc()
####### Group data and calculate mean and sd
Weather_data_Melt1 <- subset(Weather_data_Melt_all,WeatherVariable!="Precipitation")[, list(dailymean=mean(value, na.rm = T),dailySD=sd(value, na.rm = T)), by=.(Date, Location, WeatherVariable, Imputed) ]
Weather_data_Melt2 <- subset(Weather_data_Melt_all,WeatherVariable=="Precipitation")[, list(dailymean=sum(value, na.rm = T),dailySD=sd(value, na.rm = T)), by=.(Date, Location, WeatherVariable, Imputed) ]
########
Weather_data_Melt_cumulative <- rbind(Weather_data_Melt1, Weather_data_Melt2)#Weather_data_Melt2_dayNight
Weather_data_Melt_cumulative$dailymean[is.na(Weather_data_Melt_cumulative$dailymean)]
Weather_data_Melt_cumulative$Year <- format(as.Date(Weather_data_Melt_cumulative$Date, format="%Y-%m-%d"),"%Y")
Weather_data_Melt_cumulative[,CumulativeDailyMean:=cumsum(dailymean), by=.(Location, WeatherVariable, Year)]
Weather_data_Melt_cumulative[,cum_value:=cumsum(dailymean), by=.(Location, WeatherVariable, Year)]
Weather_data_Melt_cumulative[,Measure_7:=cum_value - shift(cum_value, fill = first(cum_value),n=7), by=.(Year,WeatherVariable,Location) ]
Weather_data_Melt_cumulative[,Measure_14:=cum_value - shift(cum_value, fill = first(cum_value),n=14), by=.(Year,WeatherVariable,Location)  ]
Weather_data_Melt_cumulative[,Measure_28:=cum_value - shift(cum_value, fill = first(cum_value),n=28), by=.(Year,WeatherVariable,Location)  ]
Weather_data_Melt_cumulative[,Measure_56:=cum_value - shift(cum_value, fill = first(cum_value),n=56), by=.(Year,WeatherVariable,Location)  ]
Weather_data_Melt_cumulative$cum_value <- NULL
Weather_data_Melt_cumulative <- melt.data.table(Weather_data_Melt_cumulative, id.vars=c("WeatherVariable","Location","Date","Year","Measure_7","Measure_14","Measure_28","Measure_56"),measure.vars = c("CumulativeDailyMean"),variable.name = "WeatherCalcVar",value.name="WeatherValue") ##,"SDoverTimeDailyMean"
Weather_data_Melt_cumulative <- Weather_data_Melt_cumulative[!is.na(Weather_data_Melt_cumulative$WeatherValue),]
p <- Weather_data_Melt_cumulative[, list(sum_dailymean=max(WeatherValue, na.rm = T)), by=.(Location,Year, WeatherVariable,WeatherCalcVar) ]
p <- subset(p, !WeatherVariable%in%c("PhotothermalTime_0"))
## add weather vars
Weather_data_Melt_cumulative_sub <- subset(Weather_data_Melt_cumulative,as.character(Date)%in%as.character(c(soybeans_melt$Date,soybeans_melt$date_of_sowing)))
WeatherAtSowing <- unique(Weather_data_Melt_cumulative_sub)
WeatherAtSowing$Date[is.na(WeatherAtSowing$WeatherValue)]
WeatherAtSowing$WeatherValueAtSowing <- WeatherAtSowing$WeatherValue
PhenoWeatherData <- merge.data.table(soybeans_melt, Weather_data_Melt_cumulative_sub, by=c("Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- merge.data.table(PhenoWeatherData, WeatherAtSowing[,c("Location","Date","Year","WeatherVariable","WeatherValueAtSowing")], by.x=c("WeatherVariable","Location","date_of_sowing","Year"), by.y=c("WeatherVariable","Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData
PhenoWeatherData$plot_grouped
test = PhenoWeatherData$plot_grouped
unique(PhenoWeatherData$WeatherVariable)
PhenoWeatherData <- PhenoWeatherData[!is.na(PhenoWeatherData$WeatherVariable),]
PhenoWeatherData$Sowing_to_Measure <- PhenoWeatherData$WeatherValue-PhenoWeatherData$WeatherValueAtSowing
PhenoWeatherData <- PhenoWeatherData[order(PhenoWeatherData$Date),]
nrow(p)
PhenoWeatherData <- PhenoWeatherData[,list(Sowing_to_Measure=mean(Sowing_to_Measure, na.rm=T), Measure_7=mean(Measure_7, na.rm=T), Measure_14=mean(Measure_14, na.rm=T), Measure_56=mean(Measure_56, na.rm=T), Measure_28=mean(Measure_28, na.rm=T)), by=.(Filename,genotype.name,genotype.id,Year,Location,year_site.UID,plot_number,plot.UID,plot_grouped_global,range,row,Date,value,variable,variable.1,Period,WeatherVariable,WeatherCalcVar,date_of_sowing)]
#'
#' ### Load data
#'
## -------------------------------------------------------------------------------------------------------------------------------------------------------------------
# df_o <- read.csv("data/aggregated/aggregated_PH_old.csv")
df_o <- read.csv("data/aggregated/aggregated_CC_FIP.csv")
names(PhenoWeatherData)
# this file joins the weather with the soybean data for modelling
weathter_data = read.csv("data/weather_data_for_modelling.csv")
soybean_data = read.csv("data/soybean_data_for_modelling.csv")
# only keep the necessary subset of the weather data
Weather_data_sub <- subset(weathter_data,as.character(Date)%in%as.character(c(soybean_data$Date,soybean_data$date_of_sowing)))
# include weather at sowing as varible
WeatherAtSowing <- unique(Weather_data_sub)
WeatherAtSowing$WeatherValueAtSowing <- WeatherAtSowing$WeatherValue
PhenoWeatherData <- merge.data.table(soybean_data, Weather_data_sub, by=c("Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- merge.data.table(PhenoWeatherData, WeatherAtSowing[,c("Location","Date","Year","WeatherVariable","WeatherValueAtSowing")], by.x=c("WeatherVariable","Location","date_of_sowing","Year"), by.y=c("WeatherVariable","Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- PhenoWeatherData[!is.na(PhenoWeatherData$WeatherVariable),]
# sowing to measure variables
PhenoWeatherData$Sowing_to_Measure <- PhenoWeatherData$WeatherValue-PhenoWeatherData$WeatherValueAtSowing
PhenoWeatherData <- PhenoWeatherData[order(PhenoWeatherData$Date),]
# calculate new measures : still unclear
PhenoWeatherData <- data.table(PhenoWeatherData)
PhenoWeatherData <- copy[,list(Sowing_to_Measure=mean(Sowing_to_Measure, na.rm=T), Measure_7=mean(Measure_7, na.rm=T), Measure_14=mean(Measure_14, na.rm=T), Measure_56=mean(Measure_56, na.rm=T), Measure_28=mean(Measure_28, na.rm=T)), by=.(Filename,genotype.name,genotype.id,Year,Location,year_site.UID,plot_number,plot.UID,plot_grouped,range,row,Date,value,variable,variable.1,WeatherVariable,WeatherCalcVar,date_of_sowing)]
soybean_data
# sowing to measure variables
PhenoWeatherData$Sowing_to_Measure <- PhenoWeatherData$WeatherValue-PhenoWeatherData$WeatherValueAtSowing
PhenoWeatherData <- PhenoWeatherData[order(PhenoWeatherData$Date),]
names(PhenoWeatherData)
# calculate new measures : still unclear
PhenoWeatherData <- data.table(PhenoWeatherData)
PhenoWeatherData <- copy[,list(Sowing_to_Measure=mean(Sowing_to_Measure, na.rm=T), Measure_7=mean(Measure_7, na.rm=T), Measure_14=mean(Measure_14, na.rm=T), Measure_56=mean(Measure_56, na.rm=T), Measure_28=mean(Measure_28, na.rm=T)), by=.(Filename,genotype.name,genotype.id,Year,Location,year_site.UID,plot_number,plot.UID,plot_grouped,range,row,Date,value,variable,variable.1,WeatherVariable,WeatherCalcVar,date_of_sowing)]
PhenoWeatherData <- PhenoWeatherData[,list(Sowing_to_Measure=mean(Sowing_to_Measure, na.rm=T), Measure_7=mean(Measure_7, na.rm=T), Measure_14=mean(Measure_14, na.rm=T), Measure_56=mean(Measure_56, na.rm=T), Measure_28=mean(Measure_28, na.rm=T)), by=.(Filename,genotype.name,genotype.id,Year,Location,year_site.UID,plot_number,plot.UID,plot_grouped,range,row,Date,value,variable,variable.1,WeatherVariable,WeatherCalcVar,date_of_sowing)]
PhenoWeatherData$Date[is.na(PhenoWeatherData$Sowing_to_Measure)]
PhenoWeatherData_cast <- dcast.data.table(PhenoWeatherData, Filename+genotype.name+genotype.id+Year+Location+year_site.UID+plot_number+plot.UID+plot_grouped+range+row+Date+value+variable+variable.1+Period+date_of_sowing~WeatherVariable, value.var=c("Sowing_to_Measure","Measure_7","Measure_14","Measure_56","Measure_28")) # ~WeatherVariable+WeatherCalcVar
PhenoWeatherData_cast <- dcast.data.table(PhenoWeatherData, Filename+genotype.name+genotype.id+Year+Location+year_site.UID+plot_number+plot.UID+plot_grouped+range+row+Date+value+variable+variable.1+date_of_sowing~WeatherVariable, value.var=c("Sowing_to_Measure","Measure_7","Measure_14","Measure_56","Measure_28")) # ~WeatherVariable+WeatherCalcVar
write.csv(PhenoWeatherData_cast, "data/model_data.csv")
# this file fits the model
# Packages
library(nlme)
library(stringr)
library(ggplot2)
library(dplyr)
library(broom.mixed)
library(merTools)
require(data.table)
library(data.table)
# create new variables
PhenoWeatherData_cast$time_since_sowing =( as.numeric(as.Date(PhenoWeatherData_cast$Date )-as.Date( PhenoWeatherData_cast$date_of_sowing)))
# this file joins the weather with the soybean data for modelling. Creates model_data.csv
weathter_data = read.csv("data/weather_data_for_modelling.csv")
soybean_data = read.csv("data/soybean_data_for_modelling.csv")
# only keep the necessary subset of the weather data
Weather_data_sub <- subset(weathter_data,as.character(Date)%in%as.character(c(soybean_data$Date,soybean_data$date_of_sowing)))
# include weather at sowing as varible
WeatherAtSowing <- unique(Weather_data_sub)
WeatherAtSowing$WeatherValueAtSowing <- WeatherAtSowing$WeatherValue
PhenoWeatherData <- merge.data.table(soybean_data, Weather_data_sub, by=c("Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- merge.data.table(PhenoWeatherData, WeatherAtSowing[,c("Location","Date","Year","WeatherVariable","WeatherValueAtSowing")], by.x=c("WeatherVariable","Location","date_of_sowing","Year"), by.y=c("WeatherVariable","Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- PhenoWeatherData[!is.na(PhenoWeatherData$WeatherVariable),]
# sowing to measure variables
PhenoWeatherData$Sowing_to_Measure <- PhenoWeatherData$WeatherValue-PhenoWeatherData$WeatherValueAtSowing
PhenoWeatherData <- PhenoWeatherData[order(PhenoWeatherData$Date),]
# calculate new measures : still unclear
PhenoWeatherData <- data.table(PhenoWeatherData)
PhenoWeatherData <- PhenoWeatherData[,list(Sowing_to_Measure=mean(Sowing_to_Measure, na.rm=T), Measure_7=mean(Measure_7, na.rm=T), Measure_14=mean(Measure_14, na.rm=T), Measure_56=mean(Measure_56, na.rm=T), Measure_28=mean(Measure_28, na.rm=T)), by=.(Filename,genotype.name,genotype.id,Year,Location,year_site.UID,plot_number,plot.UID,plot_grouped,range,row,Date,value,variable,variable.1,WeatherVariable,WeatherCalcVar,date_of_sowing)]
PhenoWeatherData_cast <- dcast.data.table(PhenoWeatherData, Filename+genotype.name+genotype.id+Year+Location+year_site.UID+plot_number+plot.UID+plot_grouped+range+row+Date+value+variable+variable.1+date_of_sowing~WeatherVariable, value.var=c("Sowing_to_Measure","Measure_7","Measure_14","Measure_56","Measure_28")) # ~WeatherVariable+WeatherCalcVar
# create new variables
PhenoWeatherData_cast$time_since_sowing =( as.numeric(as.Date(PhenoWeatherData_cast$Date )-as.Date( PhenoWeatherData_cast$date_of_sowing)))
# this file joins the weather with the soybean data for modelling. Creates model_data.csv
weathter_data = read.csv("data/weather_data_for_modelling.csv")
soybean_data = read.csv("data/soybean_data_for_modelling.csv")
# only keep the necessary subset of the weather data
Weather_data_sub <- subset(weathter_data,as.character(Date)%in%as.character(c(soybean_data$Date,soybean_data$date_of_sowing)))
# include weather at sowing as varible
WeatherAtSowing <- unique(Weather_data_sub)
WeatherAtSowing$WeatherValueAtSowing <- WeatherAtSowing$WeatherValue
PhenoWeatherData <- merge.data.table(soybean_data, Weather_data_sub, by=c("Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- merge.data.table(PhenoWeatherData, WeatherAtSowing[,c("Location","Date","Year","WeatherVariable","WeatherValueAtSowing")], by.x=c("WeatherVariable","Location","date_of_sowing","Year"), by.y=c("WeatherVariable","Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- PhenoWeatherData[!is.na(PhenoWeatherData$WeatherVariable),]
# sowing to measure variables
PhenoWeatherData$Sowing_to_Measure <- PhenoWeatherData$WeatherValue-PhenoWeatherData$WeatherValueAtSowing
PhenoWeatherData <- PhenoWeatherData[order(PhenoWeatherData$Date),]
# calculate new measures : still unclear
PhenoWeatherData <- data.table(PhenoWeatherData)
PhenoWeatherData <- PhenoWeatherData[,list(Sowing_to_Measure=mean(Sowing_to_Measure, na.rm=T), Measure_7=mean(Measure_7, na.rm=T), Measure_14=mean(Measure_14, na.rm=T), Measure_56=mean(Measure_56, na.rm=T), Measure_28=mean(Measure_28, na.rm=T)), by=.(Filename,genotype.name,genotype.id,Year,Location,year_site.UID,plot_number,plot.UID,plot_grouped,range,row,Date,value,variable,variable.1,WeatherVariable,WeatherCalcVar,date_of_sowing)]
PhenoWeatherData_cast <- dcast.data.table(PhenoWeatherData, Filename+genotype.name+genotype.id+Year+Location+year_site.UID+plot_number+plot.UID+plot_grouped+range+row+Date+value+variable+variable.1+date_of_sowing~WeatherVariable, value.var=c("Sowing_to_Measure","Measure_7","Measure_14","Measure_56","Measure_28")) # ~WeatherVariable+WeatherCalcVar
# create new variables
PhenoWeatherData_cast$time_since_sowing =( as.numeric(as.Date(PhenoWeatherData_cast$Date )-as.Date( PhenoWeatherData_cast$date_of_sowing)))
write.csv(PhenoWeatherData_cast, "data/model_data.csv")
# this file joins the weather with the soybean data for modelling. Creates model_data.csv
weathter_data = read.csv("data/weather_data_for_modelling.csv")
soybean_data = read.csv("data/soybean_data_for_modelling.csv")
# only keep the necessary subset of the weather data
Weather_data_sub <- subset(weathter_data,as.character(Date)%in%as.character(c(soybean_data$Date,soybean_data$date_of_sowing)))
# include weather at sowing as varible
WeatherAtSowing <- unique(Weather_data_sub)
WeatherAtSowing$WeatherValueAtSowing <- WeatherAtSowing$WeatherValue
PhenoWeatherData <- merge.data.table(soybean_data, Weather_data_sub, by=c("Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
# this file joins the weather with the soybean data for modelling. Creates model_data.csv
library(data.table)
# this file joins the weather with the soybean data for modelling. Creates model_data.csv
library(data.table)
weathter_data = read.csv("data/weather_data_for_modelling.csv")
soybean_data = read.csv("data/soybean_data_for_modelling.csv")
# only keep the necessary subset of the weather data
Weather_data_sub <- subset(weathter_data,as.character(Date)%in%as.character(c(soybean_data$Date,soybean_data$date_of_sowing)))
# include weather at sowing as varible
WeatherAtSowing <- unique(Weather_data_sub)
WeatherAtSowing$WeatherValueAtSowing <- WeatherAtSowing$WeatherValue
PhenoWeatherData <- merge.data.table(soybean_data, Weather_data_sub, by=c("Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- merge.data.table(PhenoWeatherData, WeatherAtSowing[,c("Location","Date","Year","WeatherVariable","WeatherValueAtSowing")], by.x=c("WeatherVariable","Location","date_of_sowing","Year"), by.y=c("WeatherVariable","Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- PhenoWeatherData[!is.na(PhenoWeatherData$WeatherVariable),]
# sowing to measure variables
PhenoWeatherData$Sowing_to_Measure <- PhenoWeatherData$WeatherValue-PhenoWeatherData$WeatherValueAtSowing
PhenoWeatherData <- PhenoWeatherData[order(PhenoWeatherData$Date),]
# calculate new measures : still unclear
PhenoWeatherData <- data.table(PhenoWeatherData)
PhenoWeatherData <- PhenoWeatherData[,list(Sowing_to_Measure=mean(Sowing_to_Measure, na.rm=T), Measure_7=mean(Measure_7, na.rm=T), Measure_14=mean(Measure_14, na.rm=T), Measure_56=mean(Measure_56, na.rm=T), Measure_28=mean(Measure_28, na.rm=T)), by=.(Filename,genotype.name,genotype.id,Year,Location,year_site.UID,plot_number,plot.UID,plot_grouped,range,row,Date,value,variable,variable.1,WeatherVariable,WeatherCalcVar,date_of_sowing)]
PhenoWeatherData_cast <- dcast.data.table(PhenoWeatherData, Filename+genotype.name+genotype.id+Year+Location+year_site.UID+plot_number+plot.UID+plot_grouped+range+row+Date+value+variable+variable.1+date_of_sowing~WeatherVariable, value.var=c("Sowing_to_Measure","Measure_7","Measure_14","Measure_56","Measure_28")) # ~WeatherVariable+WeatherCalcVar
# create new variables
PhenoWeatherData_cast$time_since_sowing =( as.numeric(as.Date(PhenoWeatherData_cast$Date )-as.Date( PhenoWeatherData_cast$date_of_sowing)))
# make changes that were made in the original modelling file
write.csv(PhenoWeatherData_cast, "data/model_data.csv")
PhenoWeatherData_cast
names(date         )
names(      PhenoWeatherData_cast   )
model_df = data.frame(matrix(nrow=nrow(PhenoWeatherData_cast), ncol=0))
model_df = data.frame(matrix(nrow=nrow(PhenoWeatherData_cast), ncol=0))
model_df$UID          <- PhenoWeatherData_cast$plot.UID
model_df$year         <- PhenoWeatherData_cast$Year
model_df$value <- PhenoWeatherData_cast$value
model_df$time_since_sowing <- PhenoWeatherData_cast$time_since_sowing
model_df$genotype.id  <- PhenoWeatherData_cast$genotype.id
model_df$date         <- PhenoWeatherData_cast$Date
model_df$plot_grouped <- PhenoWeatherData_cast$plot_grouped
model_df$year_site.UID <- PhenoWeatherData_cast$year_site.UID
model_df$range <- PhenoWeatherData_cast$range
model_df$row <- PhenoWeatherData_cast$row
model_df$Filename <- PhenoWeatherData_cast$Filename
model_df$Location <- PhenoWeatherData_cast$Location
model_df$year          <- ordered(as.numeric(model_df$year))
model_df$genotype.id   <- as.factor(model_df$genotype.id)
model_df$plot_grouped   <- ordered(as.factor(model_df$plot_grouped))
model_df$date          <- as.Date(model_df$date)
###### add row per plot information
unique(model_df$year_site.UID)
###### add row per plot information
model_df$Row_per_plot <- 3
model_df$Row_per_plot[df_s$year_site.UID%in%c("FPSB004","FPSB005","FPSB007")] <- 9
model_df$Row_per_plot[model_df$year_site.UID%in%c("FPSB004","FPSB005","FPSB007")] <- 9
###### create new grouping. up for changing
setDT(model_df)[,length(unique(UID)),by=plot_grouped]
df_for_grouping = model_df
df_for_grouping = unique(df_for_grouping)
df_for_grouping = model_df
df_for_grouping = unique(df_for_grouping)
df_for_grouping <- df_for_grouping[order(df_for_grouping$year_site.UID,df_for_grouping$row, df_for_grouping$range),]
df_for_grouping$row_reduced <- round((df_for_grouping$row+2)/4, digits = 0)*4
df_for_grouping$range_reduced <- round((df_for_grouping$range+1)/2, digits = 0)*2
df_for_grouping$range_reduced
class(df_for_grouping$range_reduced)
# MISTAKE here
df_for_grouping$plot_grouped_global <-  df_for_grouping$row_reduced * df_for_grouping$range_reduced
cumsum(df_for_grouping$plot_grouped)
df_for_grouping$plot_grouped_global
str(df_for_grouping$plot_grouped_global )
# unclear definitions of the global
df_for_grouping[,plot_grouped_sum:=max(plot_grouped_global),by=.(range,year_site.UID)]
df_for_grouping <- df_for_grouping[order(df_for_grouping$year_site.UID,df_for_grouping$plot_grouped_sum),]
df_for_grouping2 <- df_for_grouping
df_for_grouping <- df_for_grouping[,c("plot_grouped_sum","year_site.UID")]
df_for_grouping <- unique(df_for_grouping)
df_for_grouping$plot_grouped_sum_overall <- cumsum(df_for_grouping$plot_grouped_sum)
df_for_grouping$plot_grouped_sum_overall <- shift(df_for_grouping$plot_grouped_sum_overall,fill=0)
df_for_grouping = model_df
df_for_grouping = unique(df_for_grouping)
df_for_grouping <- df_for_grouping[order(df_for_grouping$year_site.UID,df_for_grouping$row, df_for_grouping$range),]
df_for_grouping$row_reduced <- round((df_for_grouping$row+2)/4, digits = 0)*4
df_for_grouping$range_reduced <- round((df_for_grouping$range+1)/2, digits = 0)*2
# MISTAKE here
df_for_grouping$plot_grouped_global <-  df_for_grouping$row_reduced * df_for_grouping$range_reduced
# unclear definitions of the global
df_for_grouping[,plot_grouped_sum:=max(plot_grouped_global),by=.(range,year_site.UID)]
df_for_grouping <- df_for_grouping[order(df_for_grouping$year_site.UID,df_for_grouping$plot_grouped_sum),]
df_for_grouping2 <- df_for_grouping
df_for_grouping <- df_for_grouping[,c("plot_grouped_sum","year_site.UID")]
df_for_grouping <- unique(df_for_grouping)
df_for_grouping$plot_grouped_sum_overall <- cumsum(df_for_grouping$plot_grouped_sum)
df_for_grouping$plot_grouped_sum_overall <- shift(df_for_grouping$plot_grouped_sum_overall,fill=0)
df <- merge(df_for_grouping2,df_for_grouping,by=c("year_site.UID","plot_grouped_sum"))
df <- merge(df_for_grouping3, model_df,by=c("range","row","year_site.UID"))
df_for_grouping3$plot_grouped_global <- df_for_grouping3$plot_grouped_sum_overall+df_for_grouping3$plot_grouped_global
df_for_grouping3 <- merge(df_for_grouping2,df_for_grouping,by=c("year_site.UID","plot_grouped_sum"))
df_for_grouping3$plot_grouped_global <- df_for_grouping3$plot_grouped_sum_overall+df_for_grouping3$plot_grouped_global
df <- merge(df_for_grouping3, model_df,by=c("range","row","year_site.UID"))
df_for_grouping = model_df
df_for_grouping = unique(df_for_grouping)
df_for_grouping <- df_for_grouping[order(df_for_grouping$year_site.UID,df_for_grouping$row, df_for_grouping$range),]
df_for_grouping$row_reduced <- round((df_for_grouping$row+2)/4, digits = 0)*4
df_for_grouping$range_reduced <- round((df_for_grouping$range+1)/2, digits = 0)*2
# MISTAKE here
df_for_grouping$plot_grouped_global <-  df_for_grouping$row_reduced * df_for_grouping$range_reduced
# unclear definitions of the global
df_for_grouping[,plot_grouped_sum:=max(plot_grouped_global),by=.(range,year_site.UID)]
df_for_grouping <- df_for_grouping[order(df_for_grouping$year_site.UID,df_for_grouping$plot_grouped_sum),]
df_for_grouping2 <- df_for_grouping
df_for_grouping <- df_for_grouping[,c("plot_grouped_sum","year_site.UID")]
df_for_grouping <- unique(df_for_grouping)
df_for_grouping$plot_grouped_sum_overall <- cumsum(df_for_grouping$plot_grouped_sum)
df_for_grouping$plot_grouped_sum_overall <- shift(df_for_grouping$plot_grouped_sum_overall,fill=0)
df_for_grouping3 <- merge(df_for_grouping2,df_for_grouping,by=c("year_site.UID","plot_grouped_sum"))
df_for_grouping3$plot_grouped_global <- df_for_grouping3$plot_grouped_sum_overall+df_for_grouping3$plot_grouped_global
df <- merge(df_for_grouping3, model_df,by=c("range","row","year_site.UID"))
df_for_grouping = model_df
df <- merge(df_for_grouping3, model_df,by=c("range","row","year_site.UID"))
names(model_df)model_df
names(model_df)
names(df_for_grouping3)
unique(df_for_grouping3[c("range","row","year_site.UID")])
unique(df_for_grouping3[,c("range","row","year_site.UID")])
df_for_grouping = model_df[,c("range","row","year_site.UID")]
df_for_grouping = unique(df_for_grouping)
df_for_grouping <- df_for_grouping[order(df_for_grouping$year_site.UID,df_for_grouping$row, df_for_grouping$range),]
df_for_grouping$row_reduced <- round((df_for_grouping$row+2)/4, digits = 0)*4
df_for_grouping$range_reduced <- round((df_for_grouping$range+1)/2, digits = 0)*2
# MISTAKE here
df_for_grouping$plot_grouped_global <-  df_for_grouping$row_reduced * df_for_grouping$range_reduced
# unclear definitions of the global
df_for_grouping[,plot_grouped_sum:=max(plot_grouped_global),by=.(range,year_site.UID)]
df_for_grouping <- df_for_grouping[order(df_for_grouping$year_site.UID,df_for_grouping$plot_grouped_sum),]
df_for_grouping2 <- df_for_grouping
df_for_grouping <- df_for_grouping[,c("plot_grouped_sum","year_site.UID")]
df_for_grouping <- unique(df_for_grouping)
df_for_grouping$plot_grouped_sum_overall <- cumsum(df_for_grouping$plot_grouped_sum)
df_for_grouping$plot_grouped_sum_overall <- shift(df_for_grouping$plot_grouped_sum_overall,fill=0)
df_for_grouping3 <- merge(df_for_grouping2,df_for_grouping,by=c("year_site.UID","plot_grouped_sum"))
df_for_grouping3$plot_grouped_global <- df_for_grouping3$plot_grouped_sum_overall+df_for_grouping3$plot_grouped_global
df <- merge(df_for_grouping3, model_df,by=c("range","row","year_site.UID"))
df_p$plot_grouped_global <- ordered(as.factor(df_p$plot_grouped_global))
df$plot_grouped_global <- ordered(as.factor(df$plot_grouped_global))
levels(df$plot_grouped_global) <- as.character(seq_along(levels(df$plot_grouped_global)))
# this file joins the weather with the soybean data for modelling. Creates model_data.csv
library(data.table)
weathter_data = read.csv("data/weather_data_for_modelling.csv")
soybean_data = read.csv("data/soybean_data_for_modelling.csv")
# only keep the necessary subset of the weather data
Weather_data_sub <- subset(weathter_data,as.character(Date)%in%as.character(c(soybean_data$Date,soybean_data$date_of_sowing)))
# include weather at sowing as varible
WeatherAtSowing <- unique(Weather_data_sub)
WeatherAtSowing$WeatherValueAtSowing <- WeatherAtSowing$WeatherValue
PhenoWeatherData <- merge.data.table(soybean_data, Weather_data_sub, by=c("Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- merge.data.table(PhenoWeatherData, WeatherAtSowing[,c("Location","Date","Year","WeatherVariable","WeatherValueAtSowing")], by.x=c("WeatherVariable","Location","date_of_sowing","Year"), by.y=c("WeatherVariable","Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- PhenoWeatherData[!is.na(PhenoWeatherData$WeatherVariable),]
# sowing to measure variables
PhenoWeatherData$Sowing_to_Measure <- PhenoWeatherData$WeatherValue-PhenoWeatherData$WeatherValueAtSowing
PhenoWeatherData <- PhenoWeatherData[order(PhenoWeatherData$Date),]
# calculate new measures : still unclear
PhenoWeatherData <- data.table(PhenoWeatherData)
PhenoWeatherData <- PhenoWeatherData[,list(Sowing_to_Measure=mean(Sowing_to_Measure, na.rm=T), Measure_7=mean(Measure_7, na.rm=T), Measure_14=mean(Measure_14, na.rm=T), Measure_56=mean(Measure_56, na.rm=T), Measure_28=mean(Measure_28, na.rm=T)), by=.(Filename,genotype.name,genotype.id,Year,Location,year_site.UID,plot_number,plot.UID,plot_grouped,range,row,Date,value,variable,variable.1,WeatherVariable,WeatherCalcVar,date_of_sowing)]
PhenoWeatherData_cast <- dcast.data.table(PhenoWeatherData, Filename+genotype.name+genotype.id+Year+Location+year_site.UID+plot_number+plot.UID+plot_grouped+range+row+Date+value+variable+variable.1+date_of_sowing~WeatherVariable, value.var=c("Sowing_to_Measure","Measure_7","Measure_14","Measure_56","Measure_28")) # ~WeatherVariable+WeatherCalcVar
# make changes that were made in the original modelling file -----
# create new variables
PhenoWeatherData_cast$time_since_sowing =( as.numeric(as.Date(PhenoWeatherData_cast$Date )-as.Date( PhenoWeatherData_cast$date_of_sowing)))
# rename variables, and keep only a subset of the variables
model_df = data.frame(matrix(nrow=nrow(PhenoWeatherData_cast), ncol=0))
model_df$UID          <- PhenoWeatherData_cast$plot.UID
model_df$year         <- PhenoWeatherData_cast$Year
model_df$value <- PhenoWeatherData_cast$value
model_df$time_since_sowing <- PhenoWeatherData_cast$time_since_sowing
model_df$genotype.id  <- PhenoWeatherData_cast$genotype.id
model_df$date         <- PhenoWeatherData_cast$Date
model_df$plot_grouped <- PhenoWeatherData_cast$plot_grouped
model_df$year_site.UID <- PhenoWeatherData_cast$year_site.UID
model_df$range <- PhenoWeatherData_cast$range
model_df$row <- PhenoWeatherData_cast$row
model_df$Filename <- PhenoWeatherData_cast$Filename
model_df$Location <- PhenoWeatherData_cast$Location
# type conversiion
model_df$year          <- ordered(as.numeric(model_df$year))
model_df$genotype.id   <- as.factor(model_df$genotype.id)
model_df$plot_grouped   <- ordered(as.factor(model_df$plot_grouped))
model_df$date          <- as.Date(model_df$date)
# measure variables
model_df$avg_Temperature_56 <- (PhenoWeatherData_cast$Measure_56_Temperature)
model_df$avg_Temperature_28 <- (PhenoWeatherData_cast$Measure_28_Temperature)
model_df$avg_precipitation_56 <- (PhenoWeatherData_cast$Measure_56_Precipitation)
model_df$avg_precipitation_28 <- (PhenoWeatherData_cast$Measure_28_Precipitation)
model_df$avg_radiation_28 <- (PhenoWeatherData_cast$Measure_28_RadiationSqrt)
model_df$avg_photothermal_14 <- (PhenoWeatherData_cast$Measure_28_PhotoSqrtThermal)
model_df$avg_vpd_28 <- (PhenoWeatherData_cast$Measure_28_VPD)
model_df$avg_humidity_28 <- (PhenoWeatherData_cast$Measure_28_Humidity)
###### add row per plot information
model_df$Row_per_plot <- 3
model_df$Row_per_plot[model_df$year_site.UID%in%c("FPSB004","FPSB005","FPSB007")] <- 9
######
model_df <- model_df[!is.na(model_df$value),]
model_df <- model_df[!is.nan(model_df$value),]
model_df <- model_df[!is.na(model_df$genotype.id),]
###### create new grouping. up for changing
setDT(model_df)[,length(unique(UID)),by=plot_grouped]
df_for_grouping = model_df[,c("range","row","year_site.UID")]
df_for_grouping = unique(df_for_grouping)
df_for_grouping <- df_for_grouping[order(df_for_grouping$year_site.UID,df_for_grouping$row, df_for_grouping$range),]
df_for_grouping$row_reduced <- round((df_for_grouping$row+2)/4, digits = 0)*4
df_for_grouping$range_reduced <- round((df_for_grouping$range+1)/2, digits = 0)*2
# MISTAKE here
df_for_grouping$plot_grouped_global <-  df_for_grouping$row_reduced * df_for_grouping$range_reduced
# unclear definitions of the global
df_for_grouping[,plot_grouped_sum:=max(plot_grouped_global),by=.(range,year_site.UID)]
df_for_grouping <- df_for_grouping[order(df_for_grouping$year_site.UID,df_for_grouping$plot_grouped_sum),]
df_for_grouping2 <- df_for_grouping
df_for_grouping <- df_for_grouping[,c("plot_grouped_sum","year_site.UID")]
df_for_grouping <- unique(df_for_grouping)
df_for_grouping$plot_grouped_sum_overall <- cumsum(df_for_grouping$plot_grouped_sum)
df_for_grouping$plot_grouped_sum_overall <- shift(df_for_grouping$plot_grouped_sum_overall,fill=0)
df_for_grouping3 <- merge(df_for_grouping2,df_for_grouping,by=c("year_site.UID","plot_grouped_sum"))
df_for_grouping3$plot_grouped_global <- df_for_grouping3$plot_grouped_sum_overall+df_for_grouping3$plot_grouped_global
df <- merge(df_for_grouping3, model_df,by=c("range","row","year_site.UID"))
df$plot_grouped_global <- ordered(as.factor(df$plot_grouped_global))
levels(df$plot_grouped_global) <- as.character(seq_along(levels(df$plot_grouped_global)))
# save file -----
write.csv(df, "data/model_data.csv")
df = read.csv("data/model_data.csv")
str(df)
# data "plot_grouped_global" is used for the grouping of the data
df = read.csv("data/model_data.csv")
# restore factor variables lost due to saving
df$genotype.id   <- as.factor(df$genotype.id)
df$plot_grouped_global   <- ordered(as.factor(df$plot_grouped_global))
#prepear grouping
df <- as.data.frame(df)
#prepear grouping
df <- as.data.frame(df)
df <- droplevels(df)
# grouped DF
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
library(nlme)
library(stringr)
library(ggplot2)
library(dplyr)
library(broom.mixed)
library(merTools)
library(data.table)
# grouped DF
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
df$Filename <- NULL
# grouped DF
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
# grouped DF
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
# list object for later modelling
fm1Soy.lis <- nlsList( value ~ SSlogis(time_since_sowing, Asym, xmid, scal), data = df, control=list(lower=c(0.0,0.0,0.0,0),maxiter=1000))
# set controls s.t. method converges
nlmeControl(msMaxIter = 5000, msVerbose = TRUE)
# fit first basic nlme model
fm1Soy.nlme <- nlme( fm1Soy.lis)
#update nlme model
fm1Soy.nlme <- nlme( fm1Soy.lis , random = Asym + xmid ~ 1, weights = varPower())
# vectors for starting values
dynamic_Asym <- c(soyFix[1], rep(0, 2*(length(levels(df$genotype.id)))-1))
dynamic_xmid <- c(soyFix[2], rep(0, 2))
dynamic_scal <- c(soyFix[3], rep(0, 1))
dynamic_vector <- append(dynamic_Asym, c(dynamic_xmid, dynamic_scal))
#final model
fm6.2Soy.nlme <- update(fm1Soy.nlme, fixed = list(Asym ~ genotype.id*avg_Temperature_49  , xmid ~ avg_Temperature_49 + avg_precipitation_49 , scal ~  avg_Temperature_49  ), start = dynamic_vector, control = list (msVerbose = TRUE,  maxIter = 200))
dynamic_vector
dynamic_vector <- append(dynamic_Asym, c(dynamic_xmid, dynamic_scal))
# vectors for starting values
dynamic_Asym <- c(soyFix[1], rep(0, 2*(length(levels(df$genotype.id)))-1))
# vectors for starting values
soyFix <- fixef( fm1Soy.nlme )
dynamic_Asym <- c(soyFix[1], rep(0, 2*(length(levels(df$genotype.id)))-1))
dynamic_xmid <- c(soyFix[2], rep(0, 2))
dynamic_scal <- c(soyFix[3], rep(0, 1))
dynamic_vector <- append(dynamic_Asym, c(dynamic_xmid, dynamic_scal))
#final model
fm6.2Soy.nlme <- update(fm1Soy.nlme, fixed = list(Asym ~ genotype.id*avg_Temperature_49  , xmid ~ avg_Temperature_49 + avg_precipitation_49 , scal ~  avg_Temperature_49  ), start = dynamic_vector, control = list (msVerbose = TRUE,  maxIter = 200))
#final model
fm6.2Soy.nlme <- update(fm1Soy.nlme, fixed = list(Asym ~ genotype.id*avg_Temperature_28  , xmid ~ avg_Temperature_28 + avg_precipitation_28 , scal ~  avg_Temperature_28  ), start = dynamic_vector, control = list (msVerbose = TRUE,  maxIter = 200))
fm6.2Soy.nlme
# this file fits the model
# Packages
library(nlme)
library(stringr)
library(ggplot2)
library(dplyr)
library(broom.mixed)
library(merTools)
library(data.table)
# data "plot_grouped_global" is used for the grouping of the data
df = read.csv("data/model_data.csv")
# restore factor variables lost due to saving
df$genotype.id   <- as.factor(df$genotype.id)
df$plot_grouped_global   <- ordered(as.factor(df$plot_grouped_global))
#prepear grouping
df <- as.data.frame(df)
df <- droplevels(df)
df$Filename <- NULL
#transform outcome
df$value        <- asin(sqrt(df$value))
# grouped DF
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
# list object for later modelling
fm1Soy.lis <- nlsList( value ~ SSlogis(time_since_sowing, Asym, xmid, scal), data = df, control=list(lower=c(0.0,0.0,0.0,0),maxiter=1000))
# remove outliers suggested by last year. Needed for convergence
fm1Soy.table <- as.data.frame(summary(fm1Soy.lis)$coef)
outlier_plots1 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.Asym>4)]
outlier_plots2 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.xmid>100)]
outlier_plots3 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.scal>20)]
outlier_plots4 <- fm1Soy.table$plot_grouped_global[is.na(fm1Soy.table$Estimate.scal)]
df <- subset(df, !plot_grouped_global %in%outlier_plots)
outlier_plots <- outlier_plots[!is.na(outlier_plots)]
outlier_plots <- c(outlier_plots1,outlier_plots2, outlier_plots3, outlier_plots4)
outlier_plots <- outlier_plots[!is.na(outlier_plots)]
df <- subset(df, !plot_grouped_global %in%outlier_plots)
# this file fits the model
# Packages
library(nlme)
library(stringr)
library(ggplot2)
library(dplyr)
library(broom.mixed)
library(merTools)
library(data.table)
# data "plot_grouped_global" is used for the grouping of the data
df = read.csv("data/model_data.csv")
# restore factor variables lost due to saving
df$genotype.id   <- as.factor(df$genotype.id)
df$plot_grouped_global   <- ordered(as.factor(df$plot_grouped_global))
#prepear grouping
df <- as.data.frame(df)
df <- droplevels(df)
df$Filename <- NULL
#transform outcome
df$value        <- asin(sqrt(df$value))
# grouped DF
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
# list object for later modelling
fm1Soy.lis <- nlsList( value ~ SSlogis(time_since_sowing, Asym, xmid, scal), data = df, control=list(lower=c(0.0,0.0,0.0,0),maxiter=1000))
# remove outliers suggested by last year. Needed for convergence
fm1Soy.table <- as.data.frame(summary(fm1Soy.lis)$coef)
outlier_plots1 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.Asym>4)]
outlier_plots2 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.xmid>100)]
outlier_plots3 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.scal>20)]
outlier_plots4 <- fm1Soy.table$plot_grouped_global[is.na(fm1Soy.table$Estimate.scal)]
outlier_plots <- c(outlier_plots1,outlier_plots2, outlier_plots3, outlier_plots4)
outlier_plots <- outlier_plots[!is.na(outlier_plots)]
df <- subset(df, !plot_grouped_global %in%outlier_plots)
setDT(df)[,length(genotype.id[!duplicated(genotype.id)])]
setDT(df)[,N:=nrow(.SD),by=genotype.id]
df <- subset(df, N>10)
df <- droplevels(df)
setDT(df)[,length(genotype.id[!duplicated(genotype.id)])]
df <- as.data.frame(df)
# repeat process
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
fm1Soy.lis <- nlsList( value ~ SSlogis(time_since_sowing, Asym, xmid, scal), data = df, control=list(lower=c(0.0,0.0,0.0,0),maxiter=1000))
# set controls s.t. method converges
nlmeControl(msMaxIter = 5000, msVerbose = TRUE)
fm1Soy.nlme <- nlme( fm1Soy.lis)
fm1Soy.nlme
#update nlme model
fm1Soy.nlme <- nlme( fm1Soy.lis , random = Asym + xmid ~ 1, weights = varPower())
# vectors for starting values
soyFix <- fixef( fm1Soy.nlme )
dynamic_Asym <- c(soyFix[1], rep(0, 2*(length(levels(df$genotype.id)))-1))
dynamic_xmid <- c(soyFix[2], rep(0, 2))
dynamic_scal <- c(soyFix[3], rep(0, 1))
dynamic_vector <- append(dynamic_Asym, c(dynamic_xmid, dynamic_scal))
#final model, takes a while 20 min +
fm6.2Soy.nlme <- update(fm1Soy.nlme, fixed = list(Asym ~ genotype.id*avg_Temperature_28  , xmid ~ avg_Temperature_28 + avg_precipitation_28 , scal ~  avg_Temperature_28  ), start = dynamic_vector, control = list (msVerbose = TRUE,  maxIter = 200))
fm6.2Soy.nlme
save(fm6.2Soy.nlme, file=paste0("final_model_.nlme.RData"))
