df$plot_grouped_global <- ordered(as.factor(df$plot_grouped_global))
levels(df$plot_grouped_global) <- as.character(seq_along(levels(df$plot_grouped_global)))
# this file joins the weather with the soybean data for modelling. Creates model_data.csv
library(data.table)
weathter_data = read.csv("data/weather_data_for_modelling.csv")
soybean_data = read.csv("data/soybean_data_for_modelling.csv")
# only keep the necessary subset of the weather data
Weather_data_sub <- subset(weathter_data,as.character(Date)%in%as.character(c(soybean_data$Date,soybean_data$date_of_sowing)))
# include weather at sowing as varible
WeatherAtSowing <- unique(Weather_data_sub)
WeatherAtSowing$WeatherValueAtSowing <- WeatherAtSowing$WeatherValue
PhenoWeatherData <- merge.data.table(soybean_data, Weather_data_sub, by=c("Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- merge.data.table(PhenoWeatherData, WeatherAtSowing[,c("Location","Date","Year","WeatherVariable","WeatherValueAtSowing")], by.x=c("WeatherVariable","Location","date_of_sowing","Year"), by.y=c("WeatherVariable","Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- PhenoWeatherData[!is.na(PhenoWeatherData$WeatherVariable),]
# sowing to measure variables
PhenoWeatherData$Sowing_to_Measure <- PhenoWeatherData$WeatherValue-PhenoWeatherData$WeatherValueAtSowing
PhenoWeatherData <- PhenoWeatherData[order(PhenoWeatherData$Date),]
# calculate new measures : still unclear
PhenoWeatherData <- data.table(PhenoWeatherData)
PhenoWeatherData <- PhenoWeatherData[,list(Sowing_to_Measure=mean(Sowing_to_Measure, na.rm=T), Measure_7=mean(Measure_7, na.rm=T), Measure_14=mean(Measure_14, na.rm=T), Measure_56=mean(Measure_56, na.rm=T), Measure_28=mean(Measure_28, na.rm=T)), by=.(Filename,genotype.name,genotype.id,Year,Location,year_site.UID,plot_number,plot.UID,plot_grouped,range,row,Date,value,variable,variable.1,WeatherVariable,WeatherCalcVar,date_of_sowing)]
PhenoWeatherData_cast <- dcast.data.table(PhenoWeatherData, Filename+genotype.name+genotype.id+Year+Location+year_site.UID+plot_number+plot.UID+plot_grouped+range+row+Date+value+variable+variable.1+date_of_sowing~WeatherVariable, value.var=c("Sowing_to_Measure","Measure_7","Measure_14","Measure_56","Measure_28")) # ~WeatherVariable+WeatherCalcVar
# make changes that were made in the original modelling file -----
# create new variables
PhenoWeatherData_cast$time_since_sowing =( as.numeric(as.Date(PhenoWeatherData_cast$Date )-as.Date( PhenoWeatherData_cast$date_of_sowing)))
# rename variables, and keep only a subset of the variables
model_df = data.frame(matrix(nrow=nrow(PhenoWeatherData_cast), ncol=0))
model_df$UID          <- PhenoWeatherData_cast$plot.UID
model_df$year         <- PhenoWeatherData_cast$Year
model_df$value <- PhenoWeatherData_cast$value
model_df$time_since_sowing <- PhenoWeatherData_cast$time_since_sowing
model_df$genotype.id  <- PhenoWeatherData_cast$genotype.id
model_df$date         <- PhenoWeatherData_cast$Date
model_df$plot_grouped <- PhenoWeatherData_cast$plot_grouped
model_df$year_site.UID <- PhenoWeatherData_cast$year_site.UID
model_df$range <- PhenoWeatherData_cast$range
model_df$row <- PhenoWeatherData_cast$row
model_df$Filename <- PhenoWeatherData_cast$Filename
model_df$Location <- PhenoWeatherData_cast$Location
# type conversiion
model_df$year          <- ordered(as.numeric(model_df$year))
model_df$genotype.id   <- as.factor(model_df$genotype.id)
model_df$plot_grouped   <- ordered(as.factor(model_df$plot_grouped))
model_df$date          <- as.Date(model_df$date)
# measure variables
model_df$avg_Temperature_56 <- (PhenoWeatherData_cast$Measure_56_Temperature)
model_df$avg_Temperature_28 <- (PhenoWeatherData_cast$Measure_28_Temperature)
model_df$avg_precipitation_56 <- (PhenoWeatherData_cast$Measure_56_Precipitation)
model_df$avg_precipitation_28 <- (PhenoWeatherData_cast$Measure_28_Precipitation)
model_df$avg_radiation_28 <- (PhenoWeatherData_cast$Measure_28_RadiationSqrt)
model_df$avg_photothermal_14 <- (PhenoWeatherData_cast$Measure_28_PhotoSqrtThermal)
model_df$avg_vpd_28 <- (PhenoWeatherData_cast$Measure_28_VPD)
model_df$avg_humidity_28 <- (PhenoWeatherData_cast$Measure_28_Humidity)
###### add row per plot information
model_df$Row_per_plot <- 3
model_df$Row_per_plot[model_df$year_site.UID%in%c("FPSB004","FPSB005","FPSB007")] <- 9
######
model_df <- model_df[!is.na(model_df$value),]
model_df <- model_df[!is.nan(model_df$value),]
model_df <- model_df[!is.na(model_df$genotype.id),]
###### create new grouping. up for changing
setDT(model_df)[,length(unique(UID)),by=plot_grouped]
df_for_grouping = model_df[,c("range","row","year_site.UID")]
df_for_grouping = unique(df_for_grouping)
df_for_grouping <- df_for_grouping[order(df_for_grouping$year_site.UID,df_for_grouping$row, df_for_grouping$range),]
df_for_grouping$row_reduced <- round((df_for_grouping$row+2)/4, digits = 0)*4
df_for_grouping$range_reduced <- round((df_for_grouping$range+1)/2, digits = 0)*2
# MISTAKE here
df_for_grouping$plot_grouped_global <-  df_for_grouping$row_reduced * df_for_grouping$range_reduced
# unclear definitions of the global
df_for_grouping[,plot_grouped_sum:=max(plot_grouped_global),by=.(range,year_site.UID)]
df_for_grouping <- df_for_grouping[order(df_for_grouping$year_site.UID,df_for_grouping$plot_grouped_sum),]
df_for_grouping2 <- df_for_grouping
df_for_grouping <- df_for_grouping[,c("plot_grouped_sum","year_site.UID")]
df_for_grouping <- unique(df_for_grouping)
df_for_grouping$plot_grouped_sum_overall <- cumsum(df_for_grouping$plot_grouped_sum)
df_for_grouping$plot_grouped_sum_overall <- shift(df_for_grouping$plot_grouped_sum_overall,fill=0)
df_for_grouping3 <- merge(df_for_grouping2,df_for_grouping,by=c("year_site.UID","plot_grouped_sum"))
df_for_grouping3$plot_grouped_global <- df_for_grouping3$plot_grouped_sum_overall+df_for_grouping3$plot_grouped_global
df <- merge(df_for_grouping3, model_df,by=c("range","row","year_site.UID"))
df$plot_grouped_global <- ordered(as.factor(df$plot_grouped_global))
levels(df$plot_grouped_global) <- as.character(seq_along(levels(df$plot_grouped_global)))
# save file -----
write.csv(df, "data/model_data.csv")
df = read.csv("data/model_data.csv")
str(df)
# data "plot_grouped_global" is used for the grouping of the data
df = read.csv("data/model_data.csv")
# restore factor variables lost due to saving
df$genotype.id   <- as.factor(df$genotype.id)
df$plot_grouped_global   <- ordered(as.factor(df$plot_grouped_global))
#prepear grouping
df <- as.data.frame(df)
#prepear grouping
df <- as.data.frame(df)
df <- droplevels(df)
# grouped DF
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
library(nlme)
library(stringr)
library(ggplot2)
library(dplyr)
library(broom.mixed)
library(merTools)
library(data.table)
# grouped DF
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
df$Filename <- NULL
# grouped DF
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
# grouped DF
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
# list object for later modelling
fm1Soy.lis <- nlsList( value ~ SSlogis(time_since_sowing, Asym, xmid, scal), data = df, control=list(lower=c(0.0,0.0,0.0,0),maxiter=1000))
# set controls s.t. method converges
nlmeControl(msMaxIter = 5000, msVerbose = TRUE)
# fit first basic nlme model
fm1Soy.nlme <- nlme( fm1Soy.lis)
#update nlme model
fm1Soy.nlme <- nlme( fm1Soy.lis , random = Asym + xmid ~ 1, weights = varPower())
# vectors for starting values
dynamic_Asym <- c(soyFix[1], rep(0, 2*(length(levels(df$genotype.id)))-1))
dynamic_xmid <- c(soyFix[2], rep(0, 2))
dynamic_scal <- c(soyFix[3], rep(0, 1))
dynamic_vector <- append(dynamic_Asym, c(dynamic_xmid, dynamic_scal))
#final model
fm6.2Soy.nlme <- update(fm1Soy.nlme, fixed = list(Asym ~ genotype.id*avg_Temperature_49  , xmid ~ avg_Temperature_49 + avg_precipitation_49 , scal ~  avg_Temperature_49  ), start = dynamic_vector, control = list (msVerbose = TRUE,  maxIter = 200))
dynamic_vector
dynamic_vector <- append(dynamic_Asym, c(dynamic_xmid, dynamic_scal))
# vectors for starting values
dynamic_Asym <- c(soyFix[1], rep(0, 2*(length(levels(df$genotype.id)))-1))
# vectors for starting values
soyFix <- fixef( fm1Soy.nlme )
dynamic_Asym <- c(soyFix[1], rep(0, 2*(length(levels(df$genotype.id)))-1))
dynamic_xmid <- c(soyFix[2], rep(0, 2))
dynamic_scal <- c(soyFix[3], rep(0, 1))
dynamic_vector <- append(dynamic_Asym, c(dynamic_xmid, dynamic_scal))
#final model
fm6.2Soy.nlme <- update(fm1Soy.nlme, fixed = list(Asym ~ genotype.id*avg_Temperature_49  , xmid ~ avg_Temperature_49 + avg_precipitation_49 , scal ~  avg_Temperature_49  ), start = dynamic_vector, control = list (msVerbose = TRUE,  maxIter = 200))
#final model
fm6.2Soy.nlme <- update(fm1Soy.nlme, fixed = list(Asym ~ genotype.id*avg_Temperature_28  , xmid ~ avg_Temperature_28 + avg_precipitation_28 , scal ~  avg_Temperature_28  ), start = dynamic_vector, control = list (msVerbose = TRUE,  maxIter = 200))
fm6.2Soy.nlme
# this file fits the model
# Packages
library(nlme)
library(stringr)
library(ggplot2)
library(dplyr)
library(broom.mixed)
library(merTools)
library(data.table)
# data "plot_grouped_global" is used for the grouping of the data
df = read.csv("data/model_data.csv")
# restore factor variables lost due to saving
df$genotype.id   <- as.factor(df$genotype.id)
df$plot_grouped_global   <- ordered(as.factor(df$plot_grouped_global))
#prepear grouping
df <- as.data.frame(df)
df <- droplevels(df)
df$Filename <- NULL
#transform outcome
df$value        <- asin(sqrt(df$value))
# grouped DF
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
# list object for later modelling
fm1Soy.lis <- nlsList( value ~ SSlogis(time_since_sowing, Asym, xmid, scal), data = df, control=list(lower=c(0.0,0.0,0.0,0),maxiter=1000))
# remove outliers suggested by last year. Needed for convergence
fm1Soy.table <- as.data.frame(summary(fm1Soy.lis)$coef)
outlier_plots1 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.Asym>4)]
outlier_plots2 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.xmid>100)]
outlier_plots3 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.scal>20)]
outlier_plots4 <- fm1Soy.table$plot_grouped_global[is.na(fm1Soy.table$Estimate.scal)]
df <- subset(df, !plot_grouped_global %in%outlier_plots)
outlier_plots <- outlier_plots[!is.na(outlier_plots)]
outlier_plots <- c(outlier_plots1,outlier_plots2, outlier_plots3, outlier_plots4)
outlier_plots <- outlier_plots[!is.na(outlier_plots)]
df <- subset(df, !plot_grouped_global %in%outlier_plots)
# this file fits the model
# Packages
library(nlme)
library(stringr)
library(ggplot2)
library(dplyr)
library(broom.mixed)
library(merTools)
library(data.table)
# data "plot_grouped_global" is used for the grouping of the data
df = read.csv("data/model_data.csv")
# restore factor variables lost due to saving
df$genotype.id   <- as.factor(df$genotype.id)
df$plot_grouped_global   <- ordered(as.factor(df$plot_grouped_global))
#prepear grouping
df <- as.data.frame(df)
df <- droplevels(df)
df$Filename <- NULL
#transform outcome
df$value        <- asin(sqrt(df$value))
# grouped DF
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
# list object for later modelling
fm1Soy.lis <- nlsList( value ~ SSlogis(time_since_sowing, Asym, xmid, scal), data = df, control=list(lower=c(0.0,0.0,0.0,0),maxiter=1000))
# remove outliers suggested by last year. Needed for convergence
fm1Soy.table <- as.data.frame(summary(fm1Soy.lis)$coef)
outlier_plots1 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.Asym>4)]
outlier_plots2 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.xmid>100)]
outlier_plots3 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.scal>20)]
outlier_plots4 <- fm1Soy.table$plot_grouped_global[is.na(fm1Soy.table$Estimate.scal)]
outlier_plots <- c(outlier_plots1,outlier_plots2, outlier_plots3, outlier_plots4)
outlier_plots <- outlier_plots[!is.na(outlier_plots)]
df <- subset(df, !plot_grouped_global %in%outlier_plots)
setDT(df)[,length(genotype.id[!duplicated(genotype.id)])]
setDT(df)[,N:=nrow(.SD),by=genotype.id]
df <- subset(df, N>10)
df <- droplevels(df)
setDT(df)[,length(genotype.id[!duplicated(genotype.id)])]
df <- as.data.frame(df)
# repeat process
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
fm1Soy.lis <- nlsList( value ~ SSlogis(time_since_sowing, Asym, xmid, scal), data = df, control=list(lower=c(0.0,0.0,0.0,0),maxiter=1000))
# set controls s.t. method converges
nlmeControl(msMaxIter = 5000, msVerbose = TRUE)
fm1Soy.nlme <- nlme( fm1Soy.lis)
fm1Soy.nlme
#update nlme model
fm1Soy.nlme <- nlme( fm1Soy.lis , random = Asym + xmid ~ 1, weights = varPower())
# vectors for starting values
soyFix <- fixef( fm1Soy.nlme )
dynamic_Asym <- c(soyFix[1], rep(0, 2*(length(levels(df$genotype.id)))-1))
dynamic_xmid <- c(soyFix[2], rep(0, 2))
dynamic_scal <- c(soyFix[3], rep(0, 1))
dynamic_vector <- append(dynamic_Asym, c(dynamic_xmid, dynamic_scal))
#final model, takes a while 20 min +
fm6.2Soy.nlme <- update(fm1Soy.nlme, fixed = list(Asym ~ genotype.id*avg_Temperature_28  , xmid ~ avg_Temperature_28 + avg_precipitation_28 , scal ~  avg_Temperature_28  ), start = dynamic_vector, control = list (msVerbose = TRUE,  maxIter = 200))
fm6.2Soy.nlme
save(fm6.2Soy.nlme, file=paste0("final_model_.nlme.RData"))
### This file uses the imputed weather dataframe to make a weather df that can be joined with the soybean data
# Packages ------
library(data.table)
weather <- data.table::fread("data/Weather_imputed.csv")
# feature engineering ----
# Split the df into two for better manipulation
df_w_radiation  = subset(weather,WeatherVariable=="Radiation")
df_w_radiation$value[df_w_radiation$value>800] <- 800 # impose a cap on radiation
df_w_radiation$WeatherVariable <- "RadiationSqrt" # rename variable
weather <- rbind(weather, df_w_radiation)
df_w_temperature <- subset(weather,WeatherVariable=="Temperature")
df_w_temperature$value <- df_w_temperature$value*df_w_temperature$value # make phototermal variable
df_w_temperature$WeatherVariable <- "PhotoSqrtThermal"
weather <- rbind(weather, df_w_temperature)
# Renaming Lindau to Eschikon, necessary because of the name the weather api assigns
weather[weather$Location == "Lindau",]$Location = "Eschikon"
# we remove the na values. Based on the project from 2023 they only appeared in the winter and are thus not relevant
weather = weather[!is.na(weather$value),]
# # Daytime / Nighttime variable ---------
#skipped for now as they are not used in the modelling
# formal column -----
weather$Date <- as.Date(weather$DateTime)
# Group data and calculate mean and sd, use two dfs for faster computation-----
Weather_data_1 <- subset(weather,WeatherVariable!="Precipitation")[, list(dailymean=mean(value, na.rm = T),dailySD=sd(value, na.rm = T)), by=.(Date, Location, WeatherVariable, Imputed) ]
Weather_data_2 <- subset(weather,WeatherVariable=="Precipitation")[, list(dailymean=sum(value, na.rm = T),dailySD=sd(value, na.rm = T)), by=.(Date, Location, WeatherVariable, Imputed) ]
# define measure variables (toDo: What they mean):
Weather_data_cumulative <- rbind(Weather_data_1, Weather_data_2)
Weather_data_cumulative$Year <- format(as.Date(Weather_data_cumulative$Date, format="%Y-%m-%d"),"%Y")
Weather_data_cumulative[,CumulativeDailyMean:=cumsum(dailymean), by=.(Location, WeatherVariable, Year)]
Weather_data_cumulative[,cum_value:=cumsum(dailymean), by=.(Location, WeatherVariable, Year)]
Weather_data_cumulative[,Measure_7:=cum_value - shift(cum_value, fill = first(cum_value),n=7), by=.(Year,WeatherVariable,Location) ]
Weather_data_cumulative[,Measure_14:=cum_value - shift(cum_value, fill = first(cum_value),n=14), by=.(Year,WeatherVariable,Location)  ]
Weather_data_cumulative[,Measure_28:=cum_value - shift(cum_value, fill = first(cum_value),n=28), by=.(Year,WeatherVariable,Location)  ]
Weather_data_cumulative[,Measure_56:=cum_value - shift(cum_value, fill = first(cum_value),n=56), by=.(Year,WeatherVariable,Location)  ]
Weather_data_cumulative$cum_value <- NULL
Weather_data_Melt_cumulative <- melt.data.table(Weather_data_cumulative, id.vars=c("WeatherVariable","Location","Date","Year","Measure_7","Measure_14","Measure_28","Measure_56"),measure.vars = c("CumulativeDailyMean"),variable.name = "WeatherCalcVar",value.name="WeatherValue") ##,"SDoverTimeDailyMean"
# remove NA
Weather_data_Melt_cumulative <- Weather_data_Melt_cumulative[!is.na(Weather_data_Melt_cumulative$WeatherValue),]
#print(nrow(Weather_data_Melt_cumulative))
# save df -------
write.csv(Weather_data_Melt_cumulative, "data/weather_data_for_modelling.csv")
# This pipeline uses soybean_pixels_data.csv to make a df that can be joined with the weather data
# output is call soybean_data_for_modelling.csv
# packages ---------
library(data.table)
library(stringr)
library(tidyverse)
#load data ---------
soybeans_FIP_UAV <- fread("data/soybean_pixels_data.csv")
# rename variables
colnames(soybeans_FIP_UAV)[colnames(soybeans_FIP_UAV) == "plot.range"] <- "range"
colnames(soybeans_FIP_UAV)[colnames(soybeans_FIP_UAV) == "plot.row"] <- "row"
soybeans_FIP_UAV$value <- soybeans_FIP_UAV$value_relative # this creates an additional column value that has the same entries
colnames(soybeans_FIP_UAV)[colnames(soybeans_FIP_UAV) == "Date"] <- "date"
# restrict to subsets of the data that are needed for the model
soybeans = subset(soybeans_FIP_UAV, Period=="Growth" &  variable == "Canopy_cover")
# clean data
soybeans = unique(soybeans)
soybeans = soybeans[!is.na(soybeans$value),]
soybeans = soybeans[!is.na(soybeans$genotype.id),]
soybeans <- soybeans[,c("Filename","genotype.name","genotype.id","plot.UID","range","row","Time","location","year_site.UID" ,"date","variable","Period","time_since_sowing","date_of_sowing","value")]
soybeans[soybeans$value < 0,]$value = 0 # do not allow negative CC
# order the df
soybeans = soybeans[order(soybeans$variable, soybeans$plot.UID, soybeans$date),]
#transform the plot UIDs into strings of integers
soybeans$plot_number = strtoi(str_sub(soybeans$plot.UID, -3), 10)
# Time since sowing ------
soybeans$date <- as.Date(soybeans$date)
soybeans$year = year(soybeans$date)
# Change wrongly measured fields
temp = soybeans[soybeans$year_site.UID=='FPSB006',]$range
soybeans[soybeans$year_site.UID=='FPSB006',]$range = soybeans[soybeans$year_site.UID=='FPSB006',]$row
soybeans[soybeans$year_site.UID=='FPSB006',]$row = temp
# Spatial grouping -----
max_rows_and_ranges = soybeans %>% group_by(year_site.UID) %>% summarize(max_row = max(row))
soybeans = merge(soybeans, max_rows_and_ranges, all.x = TRUE)
soybeans$row_grouped = floor((soybeans$row - 1)/ 3) + 1
soybeans[soybeans$max_row %% 3 == 1 & soybeans$row == soybeans$max_row,]$row_grouped = soybeans[soybeans$max_row %% 3 == 1 & soybeans$row == soybeans$max_row,]$row_grouped - 1
soybeans <- soybeans %>%
group_by(year_site.UID, range, row_grouped) %>%
mutate(plot_grouped = as.factor(cur_group_id()))
# indicator for closeness to border is omitted
soybeans <- soybeans[, !names(soybeans) %in% c('distance_to_border', 'distance_to_border_row_grouped', 'distance_to_border_range', 'max_row_grouped', 'max_range')]
# we keep the plot_groupded variable, but we might define a new grouping later
# rename variables again -------
colnames(soybeans)[colnames(soybeans) == "value"] <- "CC"
# symbols like / and % create problems later on, they should not be used in variable names
colnames(soybeans) <- gsub("/", "", colnames(soybeans))
colnames(soybeans) <- gsub("%", "", colnames(soybeans))
# filling in missing dates - take from R file of prev. year
df_temp = subset(soybeans)
unique_field_UIDs = sort(unique(soybeans$year_site.UID))
for (field_UID in unique_field_UIDs) {
df_field = df_temp[df_temp$year_site.UID == field_UID,]
plot_numbers = unique(df_field$plot_number)
for (plot_number in plot_numbers) {
df_plot = df_field[df_field$plot_number == plot_number,]
field_dates = sort(unique(df_field$date))
missing_dates = setdiff(as.character(field_dates), as.character(df_plot$date))
df_plot_max_PH = df_plot[df_plot$date == max(df_plot$date),]
for (missing_date in missing_dates) {
df_plot_max_PH$date = as.Date(missing_date)
df_temp = rbind(df_temp, df_plot_max_PH)
}
}
}
soybeans = left_join(soybeans,df_temp )
# renaming
soybeans$Date <- soybeans$date
soybeans$date <- NULL # dropping lower case date column
soybeans$Location <- soybeans$location
soybeans$Year <- as.character(soybeans$year)
soybeans <- setDT(soybeans)
soybeans <- unique(soybeans)
#pivot longer
soybeans_melt = melt.data.table(soybeans, measure.vars = c("CC"))
# considering only the growth period, this pipelines returns the same data points as the data_aggregation_cc file from last year.
# Nut without plotting, spatial_cc and other things unnecessary for the modelling
write.csv(soybeans_melt, "data/soybean_data_for_modelling.csv")
# this file joins the weather with the soybean data for modelling. Creates model_data.csv
library(data.table)
weathter_data = read.csv("data/weather_data_for_modelling.csv")
soybean_data = read.csv("data/soybean_data_for_modelling.csv")
# only keep the necessary subset of the weather data
Weather_data_sub <- subset(weathter_data,as.character(Date)%in%as.character(c(soybean_data$Date,soybean_data$date_of_sowing)))
# include weather at sowing as varible
WeatherAtSowing <- unique(Weather_data_sub)
WeatherAtSowing$WeatherValueAtSowing <- WeatherAtSowing$WeatherValue
PhenoWeatherData <- merge.data.table(soybean_data, Weather_data_sub, by=c("Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- merge.data.table(PhenoWeatherData, WeatherAtSowing[,c("Location","Date","Year","WeatherVariable","WeatherValueAtSowing")], by.x=c("WeatherVariable","Location","date_of_sowing","Year"), by.y=c("WeatherVariable","Location","Date","Year"), all.x = T, all.y = F, allow.cartesian=TRUE)
PhenoWeatherData <- PhenoWeatherData[!is.na(PhenoWeatherData$WeatherVariable),]
# sowing to measure variables
PhenoWeatherData$Sowing_to_Measure <- PhenoWeatherData$WeatherValue-PhenoWeatherData$WeatherValueAtSowing
PhenoWeatherData <- PhenoWeatherData[order(PhenoWeatherData$Date),]
# calculate new measures : still unclear
PhenoWeatherData <- data.table(PhenoWeatherData)
PhenoWeatherData <- PhenoWeatherData[,list(Sowing_to_Measure=mean(Sowing_to_Measure, na.rm=T), Measure_7=mean(Measure_7, na.rm=T), Measure_14=mean(Measure_14, na.rm=T), Measure_56=mean(Measure_56, na.rm=T), Measure_28=mean(Measure_28, na.rm=T)), by=.(Filename,genotype.name,genotype.id,Year,Location,year_site.UID,plot_number,plot.UID,plot_grouped,range,row,Date,value,variable,variable.1,WeatherVariable,WeatherCalcVar,date_of_sowing)]
PhenoWeatherData_cast <- dcast.data.table(PhenoWeatherData, Filename+genotype.name+genotype.id+Year+Location+year_site.UID+plot_number+plot.UID+plot_grouped+range+row+Date+value+variable+variable.1+date_of_sowing~WeatherVariable, value.var=c("Sowing_to_Measure","Measure_7","Measure_14","Measure_56","Measure_28")) # ~WeatherVariable+WeatherCalcVar
# make changes that were made in the original modelling file -----
# create new variables
PhenoWeatherData_cast$time_since_sowing =( as.numeric(as.Date(PhenoWeatherData_cast$Date )-as.Date( PhenoWeatherData_cast$date_of_sowing)))
# rename variables, and keep only a subset of the variables
model_df = data.frame(matrix(nrow=nrow(PhenoWeatherData_cast), ncol=0))
model_df$UID          <- PhenoWeatherData_cast$plot.UID
model_df$year         <- PhenoWeatherData_cast$Year
model_df$value <- PhenoWeatherData_cast$value
model_df$time_since_sowing <- PhenoWeatherData_cast$time_since_sowing
model_df$genotype.id  <- PhenoWeatherData_cast$genotype.id
model_df$date         <- PhenoWeatherData_cast$Date
model_df$plot_grouped <- PhenoWeatherData_cast$plot_grouped
model_df$year_site.UID <- PhenoWeatherData_cast$year_site.UID
model_df$range <- PhenoWeatherData_cast$range
model_df$row <- PhenoWeatherData_cast$row
model_df$Filename <- PhenoWeatherData_cast$Filename
model_df$Location <- PhenoWeatherData_cast$Location
# type conversiion
model_df$year          <- ordered(as.numeric(model_df$year))
model_df$genotype.id   <- as.factor(model_df$genotype.id)
model_df$plot_grouped   <- ordered(as.factor(model_df$plot_grouped))
model_df$date          <- as.Date(model_df$date)
# measure variables
model_df$avg_Temperature_56 <- (PhenoWeatherData_cast$Measure_56_Temperature)
model_df$avg_Temperature_28 <- (PhenoWeatherData_cast$Measure_28_Temperature)
model_df$avg_precipitation_56 <- (PhenoWeatherData_cast$Measure_56_Precipitation)
model_df$avg_precipitation_28 <- (PhenoWeatherData_cast$Measure_28_Precipitation)
model_df$avg_radiation_28 <- (PhenoWeatherData_cast$Measure_28_RadiationSqrt)
model_df$avg_photothermal_14 <- (PhenoWeatherData_cast$Measure_28_PhotoSqrtThermal)
model_df$avg_vpd_28 <- (PhenoWeatherData_cast$Measure_28_VPD)
model_df$avg_humidity_28 <- (PhenoWeatherData_cast$Measure_28_Humidity)
###### add row per plot information
model_df$Row_per_plot <- 3
model_df$Row_per_plot[model_df$year_site.UID%in%c("FPSB004","FPSB005","FPSB007")] <- 9
######
model_df <- model_df[!is.na(model_df$value),]
model_df <- model_df[!is.nan(model_df$value),]
model_df <- model_df[!is.na(model_df$genotype.id),]
###### create new grouping. up for changing
setDT(model_df)[,length(unique(UID)),by=plot_grouped]
df_for_grouping = model_df[,c("range","row","year_site.UID")]
df_for_grouping = unique(df_for_grouping)
df_for_grouping <- df_for_grouping[order(df_for_grouping$year_site.UID,df_for_grouping$row, df_for_grouping$range),]
df_for_grouping$row_reduced <- round((df_for_grouping$row+2)/4, digits = 0)*4
df_for_grouping$range_reduced <- round((df_for_grouping$range+1)/2, digits = 0)*2
# MISTAKE here
df_for_grouping$plot_grouped_global <-  df_for_grouping$row_reduced * df_for_grouping$range_reduced
# unclear definitions of the global
df_for_grouping[,plot_grouped_sum:=max(plot_grouped_global),by=.(range,year_site.UID)]
df_for_grouping <- df_for_grouping[order(df_for_grouping$year_site.UID,df_for_grouping$plot_grouped_sum),]
df_for_grouping2 <- df_for_grouping
df_for_grouping <- df_for_grouping[,c("plot_grouped_sum","year_site.UID")]
df_for_grouping <- unique(df_for_grouping)
df_for_grouping$plot_grouped_sum_overall <- cumsum(df_for_grouping$plot_grouped_sum)
df_for_grouping$plot_grouped_sum_overall <- shift(df_for_grouping$plot_grouped_sum_overall,fill=0)
df_for_grouping3 <- merge(df_for_grouping2,df_for_grouping,by=c("year_site.UID","plot_grouped_sum"))
df_for_grouping3$plot_grouped_global <- df_for_grouping3$plot_grouped_sum_overall+df_for_grouping3$plot_grouped_global
df <- merge(df_for_grouping3, model_df,by=c("range","row","year_site.UID"))
df$plot_grouped_global <- ordered(as.factor(df$plot_grouped_global))
levels(df$plot_grouped_global) <- as.character(seq_along(levels(df$plot_grouped_global)))
# save file -----
write.csv(df, "data/model_data.csv")
# this file fits the model
# Packages
library(nlme)
library(stringr)
library(ggplot2)
library(dplyr)
library(broom.mixed)
library(merTools)
library(data.table)
# data "plot_grouped_global" is used for the grouping of the data
df = read.csv("data/model_data.csv")
# restore factor variables lost due to saving
df$genotype.id   <- as.factor(df$genotype.id)
df$plot_grouped_global   <- ordered(as.factor(df$plot_grouped_global))
#prepear grouping
df <- as.data.frame(df)
df <- droplevels(df)
df$Filename <- NULL
#transform outcome
df$value        <- asin(sqrt(df$value))
# grouped DF
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
# list object for later modelling
fm1Soy.lis <- nlsList( value ~ SSlogis(time_since_sowing, Asym, xmid, scal), data = df, control=list(lower=c(0.0,0.0,0.0,0),maxiter=1000))
# remove outliers suggested by last year. Needed for convergence
fm1Soy.table <- as.data.frame(summary(fm1Soy.lis)$coef)
outlier_plots1 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.Asym>4)]
outlier_plots2 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.xmid>100)]
outlier_plots3 <- fm1Soy.table$plot_grouped_global[(fm1Soy.table$Estimate.scal>20)]
outlier_plots4 <- fm1Soy.table$plot_grouped_global[is.na(fm1Soy.table$Estimate.scal)]
outlier_plots <- c(outlier_plots1,outlier_plots2, outlier_plots3, outlier_plots4)
outlier_plots <- outlier_plots[!is.na(outlier_plots)]
df <- subset(df, !plot_grouped_global %in%outlier_plots)
setDT(df)[,length(genotype.id[!duplicated(genotype.id)])]
setDT(df)[,N:=nrow(.SD),by=genotype.id]
df <- subset(df, N>10)
df <- droplevels(df)
setDT(df)[,length(genotype.id[!duplicated(genotype.id)])]
df <- as.data.frame(df)
# repeat process
df <- groupedData(value ~ time_since_sowing | plot_grouped_global, data = df)
fm1Soy.lis <- nlsList( value ~ SSlogis(time_since_sowing, Asym, xmid, scal), data = df, control=list(lower=c(0.0,0.0,0.0,0),maxiter=1000))
# set controls s.t. method converges
nlmeControl(msMaxIter = 5000, msVerbose = TRUE)
fm1Soy.nlme <- nlme( fm1Soy.lis)
#update nlme model
fm1Soy.nlme <- nlme( fm1Soy.lis , random = Asym + xmid ~ 1, weights = varPower())
# vectors for starting values
soyFix <- fixef( fm1Soy.nlme )
dynamic_Asym <- c(soyFix[1], rep(0, 2*(length(levels(df$genotype.id)))-1))
dynamic_xmid <- c(soyFix[2], rep(0, 2))
dynamic_scal <- c(soyFix[3], rep(0, 1))
dynamic_vector <- append(dynamic_Asym, c(dynamic_xmid, dynamic_scal))
#final model, takes a while 20 min +
fm6.2Soy.nlme <- update(fm1Soy.nlme, fixed = list(Asym ~ genotype.id*avg_Temperature_28  , xmid ~ avg_Temperature_28 + avg_precipitation_28 , scal ~  avg_Temperature_28  ), start = dynamic_vector, control = list (msVerbose = TRUE,  maxIter = 200))
save(fm6.2Soy.nlme, file=paste0("final_model_.nlme.RData"))
save(fm6.2Soy.nlme, file=paste0("final_model_nlme.RData"))
fm6.2Soy.nlme
# This pipeline uses soybean_pixels_data.csv to make a df that can be joined with the weather data
# output is call soybean_data_for_modelling.csv
# packages ---------
library(data.table)
library(stringr)
library(tidyverse)
#load data ---------
soybeans_FIP_UAV <- fread("data/soybean_pixels_data.csv")
# rename variables
colnames(soybeans_FIP_UAV)[colnames(soybeans_FIP_UAV) == "plot.range"] <- "range"
colnames(soybeans_FIP_UAV)[colnames(soybeans_FIP_UAV) == "plot.row"] <- "row"
soybeans_FIP_UAV$value <- soybeans_FIP_UAV$value_relative # this creates an additional column value that has the same entries
colnames(soybeans_FIP_UAV)[colnames(soybeans_FIP_UAV) == "Date"] <- "date"
# restrict to subsets of the data that are needed for the model
soybeans = subset(soybeans_FIP_UAV, Period=="Growth" &  variable == "Canopy_cover")
# clean data
soybeans = unique(soybeans)
soybeans = soybeans[!is.na(soybeans$value),]
soybeans = soybeans[!is.na(soybeans$genotype.id),]
soybeans <- soybeans[,c("Filename","genotype.name","genotype.id","plot.UID","range","row","Time","location","year_site.UID" ,"date","variable","Period","time_since_sowing","date_of_sowing","platform", "value")]
